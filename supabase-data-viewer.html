<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase ãƒ‡ãƒ¼ã‚¿ç¢ºèªãƒ„ãƒ¼ãƒ«</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button.refresh { background: #28a745; }
        button.refresh:hover { background: #1e7e34; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 12px; }
        th { background-color: #f2f2f2; font-weight: bold; }
        .json-view { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab { padding: 8px 16px; background: #f8f9fa; border: 1px solid #ddd; cursor: pointer; border-radius: 4px 4px 0 0; }
        .tab.active { background: #007bff; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        .stat-card { padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: #007bff; }
        .stat-label { font-size: 14px; color: #666; }
    </style>
</head>
<body>
    <h1>ğŸ—„ï¸ Supabase ãƒ‡ãƒ¼ã‚¿ç¢ºèªãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="section">
        <h2>ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±è¨ˆæƒ…å ±</h2>
        <button class="refresh" onclick="loadAllStats()">ğŸ“ˆ çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°</button>
        <div id="statsResult"></div>
    </div>

    <div class="section">
        <h2>ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã¨ãƒ‡ãƒ¼ã‚¿</h2>
        <div class="tabs">
            <div class="tab active" onclick="switchTab('form_submissions')">ãŠå•ã„åˆã‚ã›</div>
            <div class="tab" onclick="switchTab('customers')">é¡§å®¢</div>
            <div class="tab" onclick="switchTab('chatgpt_accounts')">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>
            <div class="tab" onclick="switchTab('products')">è£½å“</div>
        </div>

        <div id="form_submissions" class="tab-content active">
            <h3>ğŸ“ ãŠå•ã„åˆã‚ã›ãƒ‡ãƒ¼ã‚¿ (form_submissions)</h3>
            <button onclick="loadFormSubmissions()">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>
            <button onclick="loadFormSubmissions(true)">ğŸ“Š è©³ç´°è¡¨ç¤º</button>
            <div id="formSubmissionsResult"></div>
        </div>

        <div id="customers" class="tab-content">
            <h3>ğŸ‘¥ é¡§å®¢ãƒ‡ãƒ¼ã‚¿ (customers)</h3>
            <button onclick="loadCustomers()">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>
            <button onclick="loadCustomers(true)">ğŸ“Š è©³ç´°è¡¨ç¤º</button>
            <div id="customersResult"></div>
        </div>

        <div id="chatgpt_accounts" class="tab-content">
            <h3>ğŸ¤– ChatGPTã‚¢ã‚«ã‚¦ãƒ³ãƒˆ (chatgpt_accounts)</h3>
            <button onclick="loadChatGptAccounts()">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>
            <div id="chatgptAccountsResult"></div>
        </div>

        <div id="products" class="tab-content">
            <h3>ğŸ’° è£½å“ãƒ»ãƒ—ãƒ©ãƒ³ (products)</h3>
            <button onclick="loadProducts()">ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</button>
            <div id="productsResult"></div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ” ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢</h2>
        <input type="text" id="searchTerm" placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€çµ„ç¹”åãªã©ï¼‰" style="width: 300px; padding: 8px;">
        <button onclick="searchAllTables()">ğŸ” å…¨ãƒ†ãƒ¼ãƒ–ãƒ«æ¤œç´¢</button>
        <div id="searchResult"></div>
    </div>

    <div class="section">
        <h2>ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>
        <button onclick="analyzeData()">ğŸ“Š ãƒ‡ãƒ¼ã‚¿åˆ†æå®Ÿè¡Œ</button>
        <div id="analysisResult"></div>
    </div>

    <script>
        const supabaseUrl = 'https://xyztpwuoptomidmpasxy.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5enRwd3VvcHRvbWlkbXBhc3h5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Mzk1MjUsImV4cCI6MjA1OTIxNTUyNX0.tvRP0zLfgNz0mnlBjClI-4B8nsstAXbs7_NDhz3VEzg';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${message}</div>`;
        }

        function switchTab(tabName) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        async function loadAllStats() {
            try {
                const stats = {};
                
                // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’å–å¾—
                const tables = ['form_submissions', 'customers', 'chatgpt_accounts', 'products'];
                
                for (const table of tables) {
                    try {
                        const { count, error } = await supabaseClient
                            .from(table)
                            .select('*', { count: 'exact', head: true });
                        
                        stats[table] = error ? 0 : count;
                    } catch (e) {
                        stats[table] = 'ãƒ†ãƒ¼ãƒ–ãƒ«æœªä½œæˆ';
                    }
                }

                // ç‰¹åˆ¥ãªçµ±è¨ˆ
                try {
                    const { data: formStats } = await supabaseClient
                        .from('form_submissions')
                        .select('purpose, status');
                    
                    const newSubmissions = formStats?.filter(s => s.status === 'new').length || 0;
                    const applications = formStats?.filter(s => s.purpose === 'ãŠç”³ã—è¾¼ã¿').length || 0;
                    
                    stats['new_submissions'] = newSubmissions;
                    stats['applications'] = applications;
                } catch (e) {
                    stats['new_submissions'] = 'N/A';
                    stats['applications'] = 'N/A';
                }

                const html = `
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${stats.form_submissions}</div>
                            <div class="stat-label">ãŠå•ã„åˆã‚ã›ç·æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.new_submissions}</div>
                            <div class="stat-label">æœªå¯¾å¿œãŠå•ã„åˆã‚ã›</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.applications}</div>
                            <div class="stat-label">ç”³ã—è¾¼ã¿ä»¶æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.customers}</div>
                            <div class="stat-label">ç™»éŒ²é¡§å®¢æ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.chatgpt_accounts}</div>
                            <div class="stat-label">ChatGPTã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ•°</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.products}</div>
                            <div class="stat-label">è£½å“ãƒ»ãƒ—ãƒ©ãƒ³æ•°</div>
                        </div>
                    </div>
                `;

                showResult('statsResult', html, 'success');
            } catch (error) {
                showResult('statsResult', `âŒ çµ±è¨ˆæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function loadFormSubmissions(detailed = false) {
            try {
                const { data, error } = await supabaseClient
                    .from('form_submissions')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                let html = `âœ… ãŠå•ã„åˆã‚ã›ãƒ‡ãƒ¼ã‚¿: ${data.length}ä»¶\n\n`;

                if (detailed) {
                    html += '<div class="json-view">' + JSON.stringify(data, null, 2) + '</div>';
                } else if (data.length > 0) {
                    html += '<table><thead><tr>';
                    html += '<th>ID</th><th>çµ„ç¹”å</th><th>æ‹…å½“è€…</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>ç›®çš„</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>ä½œæˆæ—¥æ™‚</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.slice(0, 10).forEach(item => {
                        html += '<tr>';
                        html += `<td>${item.id.substring(0, 8)}...</td>`;
                        html += `<td>${item.organization}</td>`;
                        html += `<td>${item.name}</td>`;
                        html += `<td>${item.email}</td>`;
                        html += `<td>${item.purpose}</td>`;
                        html += `<td>${item.status}</td>`;
                        html += `<td>${new Date(item.created_at).toLocaleString('ja-JP')}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                    if (data.length > 10) {
                        html += `<p>... ä»–${data.length - 10}ä»¶ï¼ˆè©³ç´°è¡¨ç¤ºã§å…¨ä»¶ç¢ºèªï¼‰</p>`;
                    }
                }

                showResult('formSubmissionsResult', html, 'success');
            } catch (error) {
                showResult('formSubmissionsResult', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function loadCustomers(detailed = false) {
            try {
                const { data, error } = await supabaseClient
                    .from('customers')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                let html = `âœ… é¡§å®¢ãƒ‡ãƒ¼ã‚¿: ${data.length}ä»¶\n\n`;

                if (detailed) {
                    html += '<div class="json-view">' + JSON.stringify(data, null, 2) + '</div>';
                } else if (data.length > 0) {
                    html += '<table><thead><tr>';
                    html += '<th>ID</th><th>çµ„ç¹”å</th><th>æ‹…å½“è€…</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>ãƒ—ãƒ©ãƒ³</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>ä½œæˆæ—¥æ™‚</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.forEach(item => {
                        html += '<tr>';
                        html += `<td>${item.id.substring(0, 8)}...</td>`;
                        html += `<td>${item.organization}</td>`;
                        html += `<td>${item.name}</td>`;
                        html += `<td>${item.email}</td>`;
                        html += `<td>${item.plan}</td>`;
                        html += `<td>${item.status}</td>`;
                        html += `<td>${new Date(item.created_at).toLocaleString('ja-JP')}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                }

                showResult('customersResult', html, 'success');
            } catch (error) {
                showResult('customersResult', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}\n\nğŸ’¡ customersãƒ†ãƒ¼ãƒ–ãƒ«ãŒæœªä½œæˆã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚/test-customer-conversion.html ã§ã‚¹ã‚­ãƒ¼ãƒã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚`, 'error');
            }
        }

        async function loadChatGptAccounts() {
            try {
                const { data, error } = await supabaseClient
                    .from('chatgpt_accounts')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                let html = `âœ… ChatGPTã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: ${data.length}ä»¶\n\n`;

                if (data.length > 0) {
                    html += '<table><thead><tr>';
                    html += '<th>ID</th><th>é¡§å®¢ID</th><th>ãƒ¡ãƒ¼ãƒ«</th><th>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</th><th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th><th>ä½œæˆæ—¥æ™‚</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.forEach(item => {
                        html += '<tr>';
                        html += `<td>${item.id.substring(0, 8)}...</td>`;
                        html += `<td>${item.customer_id.substring(0, 8)}...</td>`;
                        html += `<td>${item.email}</td>`;
                        html += `<td>${item.is_active ? 'âœ…' : 'âŒ'}</td>`;
                        html += `<td>${item.status}</td>`;
                        html += `<td>${new Date(item.created_at).toLocaleString('ja-JP')}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                }

                showResult('chatgptAccountsResult', html, 'success');
            } catch (error) {
                showResult('chatgptAccountsResult', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function loadProducts() {
            try {
                const { data, error } = await supabaseClient
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                let html = `âœ… è£½å“ãƒ»ãƒ—ãƒ©ãƒ³: ${data.length}ä»¶\n\n`;

                if (data.length > 0) {
                    html += '<table><thead><tr>';
                    html += '<th>ID</th><th>è£½å“å</th><th>ã‚³ãƒ¼ãƒ‰</th><th>ä¾¡æ ¼</th><th>ç¨ç‡</th><th>è«‹æ±‚å‘¨æœŸ</th><th>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</th>';
                    html += '</tr></thead><tbody>';
                    
                    data.forEach(item => {
                        html += '<tr>';
                        html += `<td>${item.id.substring(0, 8)}...</td>`;
                        html += `<td>${item.name}</td>`;
                        html += `<td>${item.code}</td>`;
                        html += `<td>Â¥${item.unit_price.toLocaleString()}</td>`;
                        html += `<td>${(item.tax_rate * 100).toFixed(1)}%</td>`;
                        html += `<td>${item.billing_cycle}</td>`;
                        html += `<td>${item.is_active ? 'âœ…' : 'âŒ'}</td>`;
                        html += '</tr>';
                    });
                    
                    html += '</tbody></table>';
                }

                showResult('productsResult', html, 'success');
            } catch (error) {
                showResult('productsResult', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function searchAllTables() {
            const searchTerm = document.getElementById('searchTerm').value.trim();
            if (!searchTerm) {
                showResult('searchResult', 'âŒ æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                let results = [];

                // form_submissionsæ¤œç´¢
                const { data: formData } = await supabaseClient
                    .from('form_submissions')
                    .select('*')
                    .or(`organization.ilike.%${searchTerm}%,name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);

                if (formData && formData.length > 0) {
                    results.push(`<h4>ğŸ“ ãŠå•ã„åˆã‚ã› (${formData.length}ä»¶)</h4>`);
                    formData.forEach(item => {
                        results.push(`â€¢ ${item.organization} - ${item.name} (${item.email}) - ${item.purpose}`);
                    });
                }

                // customersæ¤œç´¢
                const { data: customerData } = await supabaseClient
                    .from('customers')
                    .select('*')
                    .or(`organization.ilike.%${searchTerm}%,name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);

                if (customerData && customerData.length > 0) {
                    results.push(`<h4>ğŸ‘¥ é¡§å®¢ (${customerData.length}ä»¶)</h4>`);
                    customerData.forEach(item => {
                        results.push(`â€¢ ${item.organization} - ${item.name} (${item.email}) - ${item.status}`);
                    });
                }

                const html = results.length > 0 ? results.join('<br>') : 'ğŸ” æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ';
                showResult('searchResult', html, results.length > 0 ? 'success' : 'info');

            } catch (error) {
                showResult('searchResult', `âŒ æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function analyzeData() {
            try {
                const analysis = [];

                // ãŠå•ã„åˆã‚ã›åˆ†æ
                const { data: formData } = await supabaseClient
                    .from('form_submissions')
                    .select('purpose, status, created_at');

                if (formData) {
                    const purposeCount = {};
                    const statusCount = {};
                    
                    formData.forEach(item => {
                        purposeCount[item.purpose] = (purposeCount[item.purpose] || 0) + 1;
                        statusCount[item.status] = (statusCount[item.status] || 0) + 1;
                    });

                    analysis.push('<h4>ğŸ“Š ãŠå•ã„åˆã‚ã›åˆ†æ</h4>');
                    analysis.push('<strong>ç›®çš„åˆ¥:</strong>');
                    Object.entries(purposeCount).forEach(([key, value]) => {
                        analysis.push(`â€¢ ${key}: ${value}ä»¶`);
                    });
                    analysis.push('<strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥:</strong>');
                    Object.entries(statusCount).forEach(([key, value]) => {
                        analysis.push(`â€¢ ${key}: ${value}ä»¶`);
                    });
                }

                // é¡§å®¢åˆ†æ
                const { data: customerData } = await supabaseClient
                    .from('customers')
                    .select('status, plan, facility_type');

                if (customerData && customerData.length > 0) {
                    const statusCount = {};
                    const planCount = {};
                    const facilityCount = {};
                    
                    customerData.forEach(item => {
                        statusCount[item.status] = (statusCount[item.status] || 0) + 1;
                        planCount[item.plan] = (planCount[item.plan] || 0) + 1;
                        if (item.facility_type) {
                            facilityCount[item.facility_type] = (facilityCount[item.facility_type] || 0) + 1;
                        }
                    });

                    analysis.push('<h4>ğŸ‘¥ é¡§å®¢åˆ†æ</h4>');
                    analysis.push('<strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥:</strong>');
                    Object.entries(statusCount).forEach(([key, value]) => {
                        analysis.push(`â€¢ ${key}: ${value}ä»¶`);
                    });
                    analysis.push('<strong>ãƒ—ãƒ©ãƒ³åˆ¥:</strong>');
                    Object.entries(planCount).forEach(([key, value]) => {
                        analysis.push(`â€¢ ${key}: ${value}ä»¶`);
                    });
                    if (Object.keys(facilityCount).length > 0) {
                        analysis.push('<strong>æ–½è¨­ç¨®åˆ¥:</strong>');
                        Object.entries(facilityCount).forEach(([key, value]) => {
                            analysis.push(`â€¢ ${key}: ${value}ä»¶`);
                        });
                    }
                }

                const html = analysis.length > 0 ? analysis.join('<br>') : 'ğŸ“Š åˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“';
                showResult('analysisResult', html, 'success');

            } catch (error) {
                showResult('analysisResult', `âŒ åˆ†æã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // åˆæœŸãƒ­ãƒ¼ãƒ‰
        window.onload = function() {
            loadAllStats();
            loadFormSubmissions();
        };
    </script>
</body>
</html>